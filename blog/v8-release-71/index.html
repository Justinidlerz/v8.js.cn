<!doctype html><html lang=zh-CN><meta charset=utf-8><title>V8 release v7.1 · V8</title><meta content="width=device-width,initial-scale=1" name=viewport><link href=/_css/main.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><script>document.documentElement.className+=' js'</script><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li class=active><a href=/blog>博客</a><li><a href=/docs>文档</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>V8 release v7.1</h1><p class=meta>发布时间：<time datetime="2018-10-31 15:44:37" itemprop=datePublished title="2018-10-31 15:44:37">2018-10-31</time> · 标签： <a href=/blog/tags/release class=tag>release</a></header><div itemprop=articleBody><p>Every six weeks, we create a new branch of V8 as part of our <a href=/docs/release-process>release process</a>. Each version is branched from V8’s Git master immediately before a Chrome Beta milestone. Today we’re pleased to announce our newest branch, <a href=https://chromium.googlesource.com/v8/v8.git/+log/branch-heads/7.1>V8 version 7.1</a>, which is in beta until its release in coordination with Chrome 71 Stable in several weeks. V8 v7.1 is filled with all sorts of developer-facing goodies. This post provides a preview of some of the highlights in anticipation of the release.<h2 id=memory>Memory <a href=#memory class=bookmark aria-hidden=true>#</a></h2><p>Following the work in v6.9/v7.0 to <a href=/blog/embedded-builtins>embed builtins directly into the binary</a>, bytecode handlers for the interpreter are now also <a href="https://bugs.chromium.org/p/v8/issues/detail?id=8068">embedded into the binary</a>. This saves around 200 KB on average per Isolate.<h2 id=performance>Performance <a href=#performance class=bookmark aria-hidden=true>#</a></h2><p>The escape analysis in TurboFan, which performs scalar replacement for objects that are local to an optimization unit, was improved to also <a href=https://bit.ly/v8-turbofan-context-sensitive-js-operators>handle local function contexts for higher-order functions</a> when variables from the surrounding context escape to a local closure. Consider the following example:<pre class=language-js><code class=language-js><span class=highlight-line><span class="token keyword">function</span> <span class="token function">mapAdd</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class=highlight-line>  <span class="token keyword">return</span> a<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>y <span class="token operator">=></span> y <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line><span class="token punctuation">}</span></span></code></pre><p>Note that <code>x</code> is a free variable of the local closure <code>y => y + x</code>. V8 v7.1 can now fully elide the context allocation of <code>x</code>, yielding an improvement of up to <strong>40%</strong> in some cases.<figure><img alt="" src=/_img/v8-release-71/improved-escape-analysis.svg><figcaption>Performance improvement with new escape analysis (lower is better)</figcaption></figure><p>The escape analysis is now also able to eliminate some cases of variable index access to local arrays. Here’s an example:<pre class=language-js><code class=language-js><span class=highlight-line><span class="token keyword">function</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class=highlight-line>  <span class="token keyword">let</span> total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span></span><br><span class=highlight-line>    total <span class="token operator">+=</span> args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  <span class="token keyword">return</span> total<span class="token punctuation">;</span></span><br><span class=highlight-line><span class="token punctuation">}</span></span><br><br><span class=highlight-line><span class="token keyword">function</span> <span class="token function">sum2</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class=highlight-line>  <span class="token keyword">return</span> <span class="token function">sum</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line><span class="token punctuation">}</span></span></code></pre><p>Note that the <code>args</code> are local to <code>sum2</code> (assuming that <code>sum</code> is inlined into <code>sum2</code>). in V8 v7.1, TurboFan can now eliminate the allocation of <code>args</code> completely and replace the variable index access <code>args[i]</code> with a ternary operation of the form <code>i === 0 ? x : y</code>. This yields a ~2% improvement on the JetStream/EarleyBoyer benchmark. We might extend this optimization for arrays with more than two elements in the future.<h2 id=structured-cloning-of-wasm-modules>Structured cloning of Wasm modules <a href=#structured-cloning-of-wasm-modules class=bookmark aria-hidden=true>#</a></h2><p>Finally, <a href=https://github.com/WebAssembly/design/pull/1074><code>postMessage</code> is supported for Wasm modules</a>. <code>WebAssembly.Module</code> objects can now be <code>postMessage</code>'d to web workers. To clarify, this is scoped to just web workers (same process, different thread), and not extended to cross-process scenarios (such as cross-origin <code>postMessage</code> or shared web workers).<h2 id=javascript-language-features>JavaScript language features <a href=#javascript-language-features class=bookmark aria-hidden=true>#</a></h2><p><a href=https://developers.google.com/web/updates/2018/10/intl-relativetimeformat>The <code>Intl.RelativeTimeFormat</code> API</a> enables localized formatting of relative times (e.g. “yesterday”, “42 seconds ago”, or “in 3 months”) without sacrificing performance. Here's an example:<pre class=language-js><code class=language-js><span class=highlight-line><span class="token comment">// Create a relative time formatter for the English language that does</span></span><br><span class=highlight-line><span class="token comment">// not always have to use numeric value in the output.</span></span><br><span class=highlight-line><span class="token keyword">const</span> rtf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intl<span class="token punctuation">.</span>RelativeTimeFormat</span><span class="token punctuation">(</span><span class="token string">'en'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> numeric<span class="token punctuation">:</span> <span class="token string">'auto'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><br><span class=highlight-line>rtf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'day'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line><span class="token comment">// → 'yesterday'</span></span><br><br><span class=highlight-line>rtf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'day'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line><span class="token comment">// → 'today'</span></span><br><br><span class=highlight-line>rtf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'day'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line><span class="token comment">// → 'tomorrow'</span></span><br><br><span class=highlight-line>rtf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'week'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line><span class="token comment">// → 'last week'</span></span><br><br><span class=highlight-line>rtf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'week'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line><span class="token comment">// → 'this week'</span></span><br><br><span class=highlight-line>rtf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'week'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line><span class="token comment">// → 'next week'</span></span></code></pre><p>Read <a href=https://developers.google.com/web/updates/2018/10/intl-relativetimeformat>the Web Fundamentals article on <code>Intl.RelativeTimeFormat</code></a> for more information.<p>V8 v7.1 also adds support for <a href=https://github.com/tc39/proposal-global>the <code>globalThis</code> proposal</a>, enabling a universal mechanism to access the global object even in strict functions or modules regardless of the platform.<h2 id=v8-api>V8 API <a href=#v8-api class=bookmark aria-hidden=true>#</a></h2><p>Please use <code>git log branch-heads/7.0..branch-heads/7.1 include/v8.h</code> to get a list of the API changes.<p>Developers with an <a href=/docs/source-code#using-git>active V8 checkout</a> can use <code>git checkout -b 7.1 -t branch-heads/7.1</code> to experiment with the new features in V8 v7.1. Alternatively you can <a href=https://www.google.com/chrome/browser/beta.html>subscribe to Chrome’s Beta channel</a> and try the new features out yourself soon.</div><footer><div><img alt="" src=/_img/avatars/stephan-herhut.jpg height=96 lazyload=on srcset="/_img/avatars/stephan-herhut@2x.jpg 2x" width=96><p>作者：Stephan Herhut (<a href=https://twitter.com/herhut>@herhut</a>), cloned cloner of clones.</div><a href=https://twitter.com/v8js/status/1057645773465235458 class=retweet>Retweet this article!</a></footer></article></main><footer id=footer><nav><a href=/logo>品牌商标</a> · <a href=/terms>服务条款</a> · <a href=https://policies.google.com/privacy>隐私策略</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.dev/tree/master/./src/blog/v8-release-71.md rel=nofollow>在 GitHub 编辑此页面</a></nav><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>